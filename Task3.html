<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task 3</title>
    <script src="https://cdn.plot.ly/plotly-2.14.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.6/ajv.bundle.min.js" integrity="sha512-Xl0g/DHU98OkfXTsDfAAuTswzkniYQWPwLyGXzcpgDxCeH52eePfaHj/ictLAv2GvlPX2qZ6YV+3oDsw17L9qw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<header>
    <div class="container">
       <a href="index.html">
            <div class="button">
                <p>JSONGrapher</p>
            </div>
        </a>
        <a href="Task1.html">
            <div class="button">
                <p>Task 1</p>
            </div>
        </a>
        <a href="Task2.html">
            <div class="button">
                <p>Task 2</p>
            </div>
        </a>
        <a href="Task3.html">
            <div class="button active">
                <p>Task 3</p>
            </div>
        </a>
        <a href="Task4.html">
            <div class="button">
                <p>Task 4</p>
            </div>
        </a>
    </div>
</header>
<div class="page">
<h1>Task 3</h1>
    <p>Option to select a single file from computer and reset button to clear data.</p>
    <input type="file" id="file-selector"><button id="reset" onclick="clearData()">Reset data</button>
    <p>Option to drop a file on the browser:</p>
    <div id="file-drop-area" >
        Drop a file here:
    </div>
    <div id='myDiv'><!-- Plotly chart will be drawn inside this DIV --></div>
    <div id="errorDiv"></div>
</div>
<script>
    const ajv = new Ajv();
    const errorDiv = document.getElementById('errorDiv');

    function clearData(){
        document.getElementById('errorDiv').innerHTML = "";
        document.getElementById('file-selector').value = "";
        Plotly.purge('myDiv');
    }

    // load the schema first
    fetch('./data/plot-schema.json')

        .then(response => response.json())
        .then(schema => {

            if(window.FileList && window.File){

                // input file button
                document.getElementById('file-selector').addEventListener('change', event => {
                    const file = event.target.files[0];
                    const reader = new FileReader();
                    reader.addEventListener('load', event => {
                        const dataLoaded = event.target.result;
                        const jsonified = JSON.parse(dataLoaded);
                        Plotly.newPlot('myDiv', jsonified.data, jsonified.layout);
                        // output.innerHTML = (event.target.result);
                    })
                    reader.readAsText(file);
                })

                // drop area
                const dropArea = document.getElementById('file-drop-area');
                dropArea.addEventListener('dragover', event => {
                    event.stopPropagation();
                    event.preventDefault();
                    event.dataTransfer.dropEffect = 'copy';
                });
                dropArea.addEventListener('drop', event => {
                    event.stopPropagation();
                    event.preventDefault();
                    const file = event.dataTransfer.files[0];
                    const reader = new FileReader();
                    reader.addEventListener('load', event => {
                        clearData();
                        const dataLoaded = event.target.result;
                        console.log('check1...')
                        let jsonified;
                        try {
                            jsonified = JSON.parse(dataLoaded);
                        } catch(e) {
                            errorDiv.innerText = `Json file has some errors. ${e.message}`
                        }
                        console.log('check2...');
                        const validate = ajv.compile(schema);
                        const valid = validate(jsonified);
                        console.log('check3...');
                        if(!valid) {
                            console.log('validate errors: ', JSON.stringify(validate.errors));
                            errorDiv.innerText = `Json file does not match the schema. ${JSON.stringify(validate.errors)}`
                        }else{
                            console.log('trying to plot...');
                            Plotly.newPlot('myDiv', jsonified.data, jsonified.layout);
                        }
                    })
                    reader.readAsText(file);
                })
            }
        })
        .catch(e => {
            console.log(e);
            errorDiv.innerText = 'Error fetching json-schema file...'
        });
</script>
</body>
</html>